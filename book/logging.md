# Logging

## Table of Contents
- [Logging](#logging)
  - [Table of Contents](#table-of-contents)
  - [Introduction](#introduction)
  - [Types of Logs](#types-of-logs)
    - [OpenShift Logs](#openshift-logs)
    - [AWS VPC Flow Logs](#aws-vpc-flow-logs)
  - [Monitoring and Analytics Platforms](#monitoring-and-analytics-platforms)
    - [Splunk](#splunk)
  - [Splunk - Operational Information](#splunk---operational-information)
    - [Getting Access to Splunk Indices](#getting-access-to-splunk-indices)
      - [RHTAP Staging Environment](#rhtap-staging-environment)
      - [RHTAP Production Environment](#rhtap-production-environment)
      - [OpenShift Logging Configuration](#openshift-logging-configuration)
      - [Secrets](#secrets)
      - [RHTAP Staging Environment](#rhtap-staging-environment-1)
      - [RHTAP Production Environment](#rhtap-production-environment-1)
    - [Logs retention](#logs-retention)
    - [Other links](#other-links)
    - [Contact](#contact)

## Introduction

Logging is crucial for effective monitoring and troubleshooting.\
In the RHTAP environments, numerous clusters, components and services work together,
making it essential to have comprehensive logs which provide insights into their
behavior, allowing to understand and diagnose issues. Logging facilitates proactive
monitoring, enabling prompt detection of failures, abnormal behavior, or potential
security threats.\
Additionally, logs play a vital role in compliance and auditing, helping to meet
regulatory requirements and uncovering the root causes of incidents.\
Ultimately, effective logging practices contribute to enhanced operational efficiency,
streamlined troubleshooting, and maintaining a robust and secure environment.

## Types of Logs

### OpenShift Logs

As described in the [OpenShift Container Platform documentation](
    https://docs.openshift.com/container-platform/4.13/logging/cluster-logging.html),
the logging subsystem aggregates the following types of logs:

**application** - Container logs generated by user applications running in the cluster,
except infrastructure container applications.

*Note:* This includes controller audit logs are mentioned on the
[0006-log-conventions ADR](
    https://github.com/redhat-appstudio/book/blob/main/ADR/0006-log-conventions.md#controller-audit-logs)

**infrastructure** - Logs generated by infrastructure components running in the cluster
and OpenShift Container Platform nodes, such as journal logs. Infrastructure components
are pods that run in the openshift*, kube*, or default projects.

**audit** - Logs generated by auditd, the node audit system, which are stored in the
/var/log/audit/audit.log file, and the audit logs from the Kubernetes apiserver and the
OpenShift apiserver.

For more information, see:
* [Open Shift Documentation - Cluster Logging](
  https://docs.openshift.com/container-platform/4.13/logging/cluster-logging.html)
* [Open Shift Cluster Logging Operator Github repository](
  https://github.com/openshift/cluster-logging-operator)


### AWS VPC Flow Logs

VPC Flow Logs is a feature provided by Amazon Web Services (AWS) that enables to capture
information about the IP traffic going to and from network interfaces in VPCs.

VPC Flow Logs include:

1. **Traffic to and from the Internet:** This includes traffic that goes through Internet
Gateways, NAT Gateways, or Virtual Private Gateways (if using VPN or Direct Connect).

2. **Traffic Between Subnets:** VPC Flow Logs also capture traffic between different
subnets within the same VPC. This includes both inbound and outbound traffic.

3. **Traffic Between Instances:** Traffic between instances, whether they are in the same
subnet or different subnets, is captured by VPC Flow Logs. This helps monitor
communication between instances for security and troubleshooting purposes.

4. **Security Group and Network ACL Rules:** Flow Logs indicate whether network traffic
was accepted or rejected based on the rules of security groups and network ACLs.

5. **Metadata:** Flow Logs capture metadata about the traffic, including source and
destination IP addresses, source and destination ports, protocol, packet and byte counts,
etc.

6. **Communication with AWS Services:** If your instances communicate with other AWS
services that are accessible over the internet, the traffic to and from those services
is also captured.

For more information see the AWS docs about 
[Logging IP traffic using VPC Flow Logs](
    https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html).

In the scope of RHTAP, VPC Flow Logs are being forwarded to Splunk. \
The Terraform configuration and documentation reside in the following repository:\
[Terraform-aws-splunk](https://github.com/eisraeli/terraform-aws-splunk)


## Monitoring and Analytics Platforms

Platforms such as Splunk and Amazon CloudWatch, are designed to collect, store, and
analyze various types of data, including logs, metrics, events, and other forms of data
generated by different systems. Their primary goal is to provide insights into system
performance, operational efficiency, application behavior, and other operational aspects. 

### Splunk
[Splunk](https://splunk.com) is a widely used log management and analytics platform that
allows organizations to collect, index, search, analyze, and visualize machine-generated
data, including logs from various sources. Splunk provides powerful search capabilities,
real-time monitoring, alerting, and robust data visualization options.

For RHTAP, we use Splunk Cloud, which is a cloud-based version of the Splunk platform.
It is being maintained by Splunk and Red Hat's IT Splunk team.

RHTAP's Splunk: https://rhcorporate.splunkcloud.com

More information:
* [The Source - IT - Splunk](https://source.redhat.com/departments/it/splunk)

## Splunk - Operational Information

### Getting Access to Splunk Indices
Each Splunk index has a Splunk role which is associated with a Rover group. \
By being added to a Rover group, a RHTAP member gains access to a Splunk index. \
Rover groups owners are the ones who can add RHTAP members to the Rover groups. \
After being added to the Rover group(s), the related index can be accessed.

#### RHTAP Staging Environment

| **Log type**             | **Splunk Index**     | **Rover Group**                                                                                        |
|--------------------------|:---------------------|:-------------------------------------------------------------------------------------------------------|
| OpenShift application    | rh_rhtap_stage_app   | [staging-rhtap-application-logs](https://rover.redhat.com/groups/group/staging-rhtap-application-logs) |
| OpenShift infrastructure | rh_rhtap_stage_audit | [staging-rhtap-audit-logs](https://rover.redhat.com/groups/group/staging-rhtap-audit-logs)             |
| OpenShift audit          | rh_rhtap_stage_audit | [staging-rhtap-audit-logs](https://rover.redhat.com/groups/group/staging-rhtap-audit-logs)             |
| AWS VPC Flow Logs        | rh_rhtap_stage_vpc   | [staging-rhtap-vpc-flow-logs](https://rover.redhat.com/groups/group/staging-rhtap-vpc-flow-logs)       |

#### RHTAP Production Environment

| **Log type**             | **Splunk Index**          | **Rover Group**                                                                                              |
|--------------------------|:--------------------------|:-------------------------------------------------------------------------------------------------------------|
| OpenShift application    | rh_rhtap_production_app   | [production-rhtap-application-logs](https://rover.redhat.com/groups/group/production-rhtap-application-logs) |
| OpenShift infrastructure | rh_rhtap_production_audit | [production-rhtap-audit-logs](https://rover.redhat.com/groups/group/production-rhtap-audit-logs)             |
| OpenShift audit          | rh_rhtap_production_audit | [production-rhtap-audit-logs](https://rover.redhat.com/groups/group/production-rhtap-audit-logs)             |
| AWS VPC Flow Logs        | rh_rhtap_production_audit | [production-rhtap-vpc-flow-logs](https://rover.redhat.com/groups/group/production-rhtap-vpc-flow-logs)       |


#### OpenShift Logging Configuration
https://github.com/redhat-appstudio/infra-deployments/tree/main/components/monitoring/logging

#### Secrets
Secrets are stored in [Hashicorp Vault](https://vault.devshift.net).

#### RHTAP Staging Environment
| **Secret Name**                            | **Vault Path**            |
|:-------------------------------------------|:--------------------------|
| splunk-forwarder-rhtap-staging-application | [stonesoup/staging/monitoring/logging/fluentd/splunk-forwarder-rhtap-staging-application](https://vault.devshift.net/ui/vault/secrets/stonesoup/show/staging/monitoring/logging/fluentd/splunk-forwarder-rhtap-staging-application) |
| splunk-forwarder-rhtap-staging-audit       | [stonesoup/staging/monitoring/logging/fluentd/splunk-forwarder-rhtap-staging-audit](https://vault.devshift.net/ui/vault/secrets/stonesoup/show/staging/monitoring/logging/fluentd/splunk-forwarder-rhtap-staging-audit) |
| rh_rhtap_staging_vpc                       | [stonesoup/staging/monitoring/logging/rh_rhtap_staging_vpc](https://vault.devshift.net/ui/vault/secrets/stonesoup/show/staging/monitoring/logging/rh_rhtap_staging_vpc) |

#### RHTAP Production Environment
| **Secret Name**                               | **Vault Path**            |
|-----------------------------------------------|:--------------------------|
| splunk-forwarder-rhtap-production-application | [stonesoup/production/monitoring/logging/fluentd/splunk-forwarder-rhtap-production-application](https://vault.devshift.net/ui/vault/secrets/stonesoup/show/production/monitoring/logging/fluentd/splunk-forwarder-rhtap-production-application)  |
| splunk-forwarder-rhtap-production-audit       | [stonesoup/production/monitoring/logging/fluentd/splunk-forwarder-rhtap-production-audit](https://vault.devshift.net/ui/vault/secrets/stonesoup/show/production/monitoring/logging/fluentd/splunk-forwarder-rhtap-production-audit) |
| rh_rhtap_staging_vpc                          | [stonesoup/production/monitoring/logging/rh_rhtap_production_vpc](https://vault.devshift.net/ui/vault/secrets/stonesoup/show/production/monitoring/logging/rh_rhtap_production_vpc) |

**Notice** Secrets are also backed-up in the o11y team's BitWarden vault.

### Logs retention
Logs are being retained for 60 days.

### Other links
* [Applicative Log Conventions](https://github.com/redhat-appstudio/book/blob/main/ADR/0006-log-conventions.md#controller-audit-logs)

### Contact
RHTAP logs are being managed by the o11y team.\
The team can be reached on the following Slack channel:\
[#forum-rhtap-o11y](https://redhat-internal.slack.com/archives/C04FDFTF8EB)
